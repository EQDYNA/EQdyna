#! /bin/bash
#SBATCH -J 201
#SBATCH -o a.eqdyna.log%j
#SBATCH -N 1
#SBATCH -n 4
#SBATCH -p normal
#SBATCH -t 00:10:00
#SBATCH -A EAR22013
#SBATCH --mail-user=
#SBATCH --mail-type=begin
#SBATCH --mail-type=end
  read i < currentcycle.txt
# fetch input files from /eqdyna
  cp eqdyna/bFaultGeometry.txt ./
  cp eqdyna/bGlobal.txt ./
  cp eqdyna/bMaterial.txt ./
  cp eqdyna/bModelGeometry.txt ./
  cp eqdyna/bStations.txt ./
  cp eqdyna/on_fault_vars_input.nc ./
  cp eqdyna/rough_geo_cycle.txt ./
# fetch fault.r.nc from Q(i-1)
  cp "Q$((i-1))/"fault.r.nc ./
# run eqdyna
  ibrun eqdyna
# move results to D(i-1)
# delete D(i-1)
  rm -rf "D$((i-1))"
# create D(i-1) and copy results and inputs over
  mkdir "D$((i-1))"
  cp -r a.eqdyna.log* *.r.nc "D$((i-1))"
  cp -r on_fault_vars_input.nc "D$((i-1))"
  cp -r currentcycle.txt "D$((i-1))"
  cp -r body* faultst* frt.txt* global* gm* p2* "D$((i-1))"
  cp -r currentcycle.txt "D$((i-1))"
  cp -r eqdyna/plotRuptureDynamics "D$((i-1))"
  cp -r eqdyna/user_defined_params.py "D$((i-1))"
  cp -r eqdyna/lib.py "D$((i-1))"
# clean up the root for running eqquasi
  rm -rf a.eqdyna.log* bFaultGeometry.txt bGlobal.txt
  rm -rf bMaterial.txt bModelGeometry.txt
  rm -rf bStations.txt *.r.nc
  rm -rf on_fault_vars_input.nc
  rm -rf body* faultst* frt.txt* global* gm* p2* 
# postprocessing
  cd "D$((i-1))"
  ibrun -np 1 python plotRuptureDynamics
  cd ..
# update cycle id i
  i=$((i+1))
  echo $i > currentcycle.txt
